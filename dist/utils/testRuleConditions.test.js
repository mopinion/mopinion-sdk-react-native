var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _reactNative=require("react-native");var _asyncStorage=_interopRequireDefault(require("@react-native-async-storage/async-storage"));var _testRuleConditions=_interopRequireDefault(require("./testRuleConditions"));jest.mock('@react-native-async-storage/async-storage',function(){return{getItem:jest.fn(),setItem:jest.fn()};});jest.mock('react-native',function(){return{Platform:{OS:'ios',Version:'14.5'}};});describe('testRuleConditions',function(){beforeEach(function(){jest.clearAllMocks();_asyncStorage.default.getItem.mockReset();_asyncStorage.default.setItem.mockReset();});describe('Basic rule testing',function(){it('should return false if rule was already shown',(0,_asyncToGenerator2.default)(function*(){var currentDate=new Date();var rule={rule_id:'123',trigger:'proactive',session:1};_asyncStorage.default.getItem.mockImplementation(function(key){if(key===`mopinion_${rule.rule_id}`){return Promise.resolve(JSON.stringify({shown:true,date:currentDate.toISOString(),trigger:'proactive',percentage:50}));}return Promise.resolve(null);});var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(false);expect(_asyncStorage.default.setItem).not.toHaveBeenCalled();}));it('should return true when forced',(0,_asyncToGenerator2.default)(function*(){var rule={rule_id:'123'};var result=yield(0,_testRuleConditions.default)(rule,true);expect(result).toBe(true);}));it('should return true if rule was not previously shown',(0,_asyncToGenerator2.default)(function*(){var currentDate=new Date();var rule={rule_id:'123',trigger:'proactive',session:1};_asyncStorage.default.getItem.mockImplementation(function(key){if(key===`mopinion_${rule.rule_id}`){return Promise.resolve(JSON.stringify({shown:false,date:currentDate.toISOString(),trigger:'proactive',percentage:50}));}return Promise.resolve(null);});var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(true);expect(_asyncStorage.default.setItem).toHaveBeenCalledWith(`mopinion_${rule.rule_id}`,expect.any(String));}));});describe('Percentage condition',function(){it('should return true when percentage is invalid',(0,_asyncToGenerator2.default)(function*(){var rule={rule_id:'123',percentage:101};var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(true);}));it('should return false when percentage is 0',(0,_asyncToGenerator2.default)(function*(){var rule={rule_id:'123',percentage:0};var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(false);}));});describe('Target condition',function(){it('should match correct platform and version',(0,_asyncToGenerator2.default)(function*(){var rule={rule_id:'123',target:[{os:'ios',version:['14.5']}]};var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(true);}));it('should not match incorrect platform',(0,_asyncToGenerator2.default)(function*(){var rule={rule_id:'123',target:[{os:'android',version:['14.5']}]};var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(false);}));});describe('Date condition',function(){beforeEach(function(){jest.useFakeTimers();jest.setSystemTime(new Date('2024-03-20'));});afterEach(function(){jest.useRealTimers();});it('should correctly evaluate earlier date',(0,_asyncToGenerator2.default)(function*(){var rule={rule_id:'123',date:{operator:'later',date:'19/03/2024'}};var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(true);}));it('should correctly evaluate between dates',(0,_asyncToGenerator2.default)(function*(){var rule={rule_id:'123',date:{operator:'between',date:'19/03/2024',date2:'21/03/2024'}};var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(true);}));});describe('Clock condition',function(){beforeEach(function(){jest.useFakeTimers();jest.setSystemTime(new Date('2024-03-20T14:30:00'));});afterEach(function(){jest.useRealTimers();});it('should correctly evaluate exact time',(0,_asyncToGenerator2.default)(function*(){var rule={rule_id:'123',clock:{operator:'exactly',time:'14:30'}};var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(true);}));it('should correctly evaluate between times',(0,_asyncToGenerator2.default)(function*(){var rule={rule_id:'123',clock:{operator:'between',time:'14:00',time2:'15:00'}};var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(true);}));});describe('Session handling',function(){it('should initialize new session when expired',(0,_asyncToGenerator2.default)(function*(){var oldDate=new Date();oldDate.setDate(oldDate.getDate()-2);_asyncStorage.default.getItem.mockResolvedValue(JSON.stringify({date:oldDate.toISOString(),shown:true}));var rule={rule_id:'123',session:1,trigger:'proactive'};var result=yield(0,_testRuleConditions.default)(rule);expect(_asyncStorage.default.setItem).toHaveBeenCalledWith('mopinion_123',expect.any(String));var savedState=JSON.parse(_asyncStorage.default.setItem.mock.calls[0][1]);expect(savedState).toHaveProperty('date');expect(savedState.shown).toBe(true);expect(result).toBe(true);}));it('should maintain session for passive triggers',(0,_asyncToGenerator2.default)(function*(){var rule={rule_id:'123',trigger:'passive'};yield(0,_testRuleConditions.default)(rule);expect(_asyncStorage.default.setItem).toHaveBeenCalledWith('mopinion_123',expect.any(String));var lastCall=_asyncStorage.default.setItem.mock.calls[0];var savedState=JSON.parse(lastCall[1]);expect(savedState.shown).toBe(false);}));});describe('Error handling',function(){it('should handle AsyncStorage errors gracefully',(0,_asyncToGenerator2.default)(function*(){_asyncStorage.default.getItem.mockRejectedValue(new Error('Storage error'));var rule={rule_id:'123'};var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(true);}));});describe('Passive trigger handling',function(){it('should always show passive triggers regardless of session state',(0,_asyncToGenerator2.default)(function*(){var rule={rule_id:'passive_rule',trigger:'passive',session:1};_asyncStorage.default.getItem.mockResolvedValue(JSON.stringify({shown:false,date:new Date().toISOString()}));var result=yield(0,_testRuleConditions.default)(rule);expect(result).toBe(true);expect(_asyncStorage.default.setItem).toHaveBeenCalledWith(`mopinion_${rule.rule_id}`,expect.stringContaining('"shown":false'));}));});});