var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=testRuleConditions;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _reactNative=require("react-native");var _asyncStorage=_interopRequireDefault(require("@react-native-async-storage/async-storage"));var _=require("./");function testRuleConditions(_x,_x2,_x3){return _testRuleConditions.apply(this,arguments);}function _testRuleConditions(){_testRuleConditions=(0,_asyncToGenerator2.default)(function*(rule,event,force){var conditions={operators:{earlier:function earlier(x,y){return x<y;},exactly:function exactly(x,y){return x==y;},later:function later(x,y){return x>y;},between:function between(x,y,z){return conditions.operators.later(z,x)&&conditions.operators.earlier(z,y);}},percentage:function percentage(perc){var rnd=Math.round(Math.random()*100);return rnd<Number(perc);},target:function target(targetArr){var testTarget=function testTarget(target){var OS=_reactNative.Platform.OS===target.os;var version=!target.version.length||target.version.length&&target.version.indexOf(String(_reactNative.Platform.Version))>-1;return OS&&version;};return targetArr.filter(function(o){return testTarget(o);}).length;},date:function date(_date){var formatString=function formatString(s){var arr=s.split('/').reverse().join('-');return arr;};var formatDate=function formatDate(d){return new Date(d.setHours(0,0,0,0)).getTime();};var formatAll=function formatAll(s){return formatDate(new Date(formatString(s)));};if(_date.operator!=='between'){return conditions.operators[_date.operator](formatDate(new Date()),formatAll(_date.date));}else{var compareDate2=formatAll(_date.date2);return conditions.operators[_date.operator](formatAll(_date.date),formatAll(_date.date2),formatDate(new Date()));}},clock:function clock(_clock){var now=new Date();now=('0'+now.getHours()).slice(-2)+':'+('0'+now.getMinutes()).slice(-2);if(_clock.operator!=='between'){return conditions.operators[_clock.operator](now,_clock.time);}else{return conditions.operators[_clock.operator](_clock.time,_clock.time2,now);}},session:function session(_session,state){var inDays=function inDays(d){return Math.ceil(d/(1000*3600*24));};var now=inDays(new Date().getTime());var prev=state!=null&&state.date?inDays(new Date(state.date).getTime()):0;return rule.trigger==='passive'?rule.trigger==='passive':now-prev>Number(_session);}};return _asyncStorage.default.getItem(`${rule.rule_id}.${event}`).then(function(storageString){var ruleState=(0,_.tryParse)(storageString);var show=force||(0,_.objectKeys)(rule).every(function(k){if(conditions.hasOwnProperty(k)&&rule[k]&&((0,_.objectKeys)(rule[k]).length>0||!isNaN(parseInt(rule[k],10)))){return conditions[k](rule[k],ruleState);}return true;});if(show){_asyncStorage.default.setItem(`${rule.rule_id}.${event}`,JSON.stringify({shown:true,date:new Date(),trigger:rule.trigger,event:event}));}return show;}).catch(function(e){console.log(e);});});return _testRuleConditions.apply(this,arguments);}