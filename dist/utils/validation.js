Object.defineProperty(exports,"__esModule",{value:true});exports.textInputBlocks=exports.requireAllBlockTypes=void 0;exports.validate=validate;var _index=require("./index");var textInputBlocks=exports.textInputBlocks=['input','textarea','email','phone','name','firstname','lastname'];var requireAllBlockTypes=exports.requireAllBlockTypes=['matrix','likert'];var rules={required:function required(value){if(typeof value==='boolean'){return value;}return String(value).trim().length>0;},email:function email(value){return /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(value);},phone:function phone(value){return value.length>9&&/^[\(\)\s\-\+\d]{10,17}$/.test(value);},max:function max(value,_max){return value.length<=_max;},min:function min(value,_min){return value.length>=_min;}};function isRequiredContact(_ref){var _block$properties$ele,_block$properties;var _ref$block=_ref.block,block=_ref$block===void 0?{}:_ref$block,datafieldId=_ref.datafieldId;return(0,_index.objectKeys)((_block$properties$ele=(_block$properties=block.properties)==null?void 0:_block$properties.elements)!=null?_block$properties$ele:{}).some(function(key){var element=block.properties.elements[key];if(element.data_field===datafieldId){return element.required;}if(!element.combine&&element.subelements){var isSubElement=(0,_index.objectKeys)(element.subelements).some(function(subKey){var subElement=element.subelements[subKey];return subElement.data_field===datafieldId;});if(isSubElement){return element.required;}}return false;});}function isContactEmail(_ref2){var _block$properties2,_block$properties2$el,_block$properties2$el2;var datafieldId=_ref2.datafieldId,_ref2$block=_ref2.block,block=_ref2$block===void 0?{}:_ref2$block;return((_block$properties2=block.properties)==null?void 0:(_block$properties2$el=_block$properties2.elements)==null?void 0:(_block$properties2$el2=_block$properties2$el.email)==null?void 0:_block$properties2$el2.data_field)===datafieldId;}function isContactPhone(_ref3){var _block$properties3,_block$properties3$el,_block$properties3$el2,_block$properties4,_block$properties4$el;var datafieldId=_ref3.datafieldId,_ref3$block=_ref3.block,block=_ref3$block===void 0?{}:_ref3$block;return((_block$properties3=block.properties)==null?void 0:(_block$properties3$el=_block$properties3.elements)==null?void 0:(_block$properties3$el2=_block$properties3$el.phone)==null?void 0:_block$properties3$el2.data_field)===datafieldId||((_block$properties4=block.properties)==null?void 0:(_block$properties4$el=_block$properties4.elements)==null?void 0:_block$properties4$el.phone2)===datafieldId;}function getExtraInputElement(){var _block$properties5,_block$properties6;var block=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!((_block$properties5=block.properties)!=null&&_block$properties5.elements_extra)){return null;}return block.properties.elements_extra[(0,_index.objectKeys)((_block$properties6=block.properties)==null?void 0:_block$properties6.elements_extra).pop()];}var reasonToErrorMessageKeyMap={required:'required',requiredCheckbox:'required',requiredContact:'required',requiredMulti:'required_multi',requiredExtra:'required',email:'invalid_email',businessEmail:'invalid_business_email',phone:'invalid_phone',min:'too_short',max:'too_long',minExtra:'too_short',maxExtra:'too_long',minOptions:'min_options',maxOptions:'max_options',recaptcha:'required'};function validate(_ref4){var _ref4$block=_ref4.block,block=_ref4$block===void 0?{}:_ref4$block,state=_ref4.state,datafieldId=_ref4.datafieldId,_ref4$allowedEmails=_ref4.allowedEmails,allowedEmails=_ref4$allowedEmails===void 0?[]:_ref4$allowedEmails;var validators={required:function required(){var _block$properties7;if(!datafieldId&&(_block$properties7=block.properties)!=null&&_block$properties7.required&&requireAllBlockTypes.indexOf(block.typeName)===-1){return rules.required(state.value);}if(block.typeName==='contact'&&isRequiredContact({block:block,datafieldId:datafieldId})){return rules.required(state[datafieldId].value);}return true;},requiredCheckbox:function requiredCheckbox(){var _block$properties8;if(block.typeName==='checkbox'&&(_block$properties8=block.properties)!=null&&_block$properties8.required){return(0,_index.objectKeys)(state).filter(function(key){return(0,_index.isNestedStateProp)(key);}).some(function(key){return rules.required(state[key].value);});}return true;},requiredContact:function requiredContact(){if(block.typeName==='contact'&&isRequiredContact({block:block,datafieldId:datafieldId})){return rules.required(state[datafieldId].value);}return true;},requiredMulti:function requiredMulti(){var _block$properties9;if((_block$properties9=block.properties)!=null&&_block$properties9.required&&requireAllBlockTypes.indexOf(block.typeName)>-1){var filtered=(0,_index.objectKeys)(state).filter(function(key){return(0,_index.isNestedStateProp)(key);});return filtered.every(function(key){return rules.required(state[key].value);});}return true;},requiredExtra:function requiredExtra(){var _block$properties10;var extraInputElement=getExtraInputElement(block);if((_block$properties10=block.properties)!=null&&_block$properties10.required&&extraInputElement&&state[extraInputElement.data_field].isVisible){return rules.required(state[extraInputElement.data_field].value);}return true;},email:function email(){var _block$properties11;if(block.typeName==='email'||((_block$properties11=block.properties)==null?void 0:_block$properties11.format)==='email'){return!state.value||rules.email(state.value);}if(block.typeName==='contact'&&isContactEmail({block:block,datafieldId:datafieldId})){return!state[datafieldId].value||rules.email(state[datafieldId].value);}return true;},businessEmail:function businessEmail(){var _block$properties12,_block$properties13,_block$properties13$e,_block$properties13$e2;if((_block$properties12=block.properties)!=null&&_block$properties12.business_only||(_block$properties13=block.properties)!=null&&(_block$properties13$e=_block$properties13.elements)!=null&&(_block$properties13$e2=_block$properties13$e.email)!=null&&_block$properties13$e2.business_only&&isContactEmail({block:block,datafieldId:datafieldId})){var value=datafieldId?state[datafieldId].value:state.value;return rules.email(value)&&allowedEmails.indexOf(value)!==-1;}return true;},phone:function phone(){var _block$properties14;if(block.typeName==='phone'||((_block$properties14=block.properties)==null?void 0:_block$properties14.format)==='tel'){return rules.phone(state.value);}if(block.typeName==='contact'&&isContactPhone({block:block,datafieldId:datafieldId})){return rules.phone(state[datafieldId].value);}return true;},min:function min(){var _block$properties15,_block$properties15$b;if((_block$properties15=block.properties)!=null&&(_block$properties15$b=_block$properties15.boundary)!=null&&_block$properties15$b.limitMin&&textInputBlocks.indexOf(block.typeName)>-1){var _block$properties16,_block$properties16$b;return rules.min(state.value,Number((_block$properties16=block.properties)==null?void 0:(_block$properties16$b=_block$properties16.boundary)==null?void 0:_block$properties16$b.limitMin));}return true;},max:function max(){var _block$properties17,_block$properties17$b;if((_block$properties17=block.properties)!=null&&(_block$properties17$b=_block$properties17.boundary)!=null&&_block$properties17$b.limitMax&&textInputBlocks.indexOf(block.typeName)>-1){var _block$properties18,_block$properties18$b;return rules.max(state.value,Number((_block$properties18=block.properties)==null?void 0:(_block$properties18$b=_block$properties18.boundary)==null?void 0:_block$properties18$b.limitMax));}return true;},minExtra:function minExtra(){var _block$properties19,_block$properties19$b;var extraInputElement=getExtraInputElement(block);if((_block$properties19=block.properties)!=null&&(_block$properties19$b=_block$properties19.boundary)!=null&&_block$properties19$b.limitMin&&extraInputElement&&state[extraInputElement.data_field].isVisible){var _block$properties20,_block$properties20$b;return rules.min(state[extraInputElement.data_field].value,Number((_block$properties20=block.properties)==null?void 0:(_block$properties20$b=_block$properties20.boundary)==null?void 0:_block$properties20$b.limitMin));}return true;},maxExtra:function maxExtra(){var _block$properties21,_block$properties21$b;var extraInputElement=getExtraInputElement(block);if((_block$properties21=block.properties)!=null&&(_block$properties21$b=_block$properties21.boundary)!=null&&_block$properties21$b.limitMax&&extraInputElement&&state[extraInputElement.data_field].isVisible){var _block$properties22,_block$properties22$b;return rules.max(state[extraInputElement.data_field].value,Number((_block$properties22=block.properties)==null?void 0:(_block$properties22$b=_block$properties22.boundary)==null?void 0:_block$properties22$b.limitMax));}return true;},minOptions:function minOptions(){var _block$properties23;if((_block$properties23=block.properties)!=null&&_block$properties23.minSelected){var selected=(0,_index.objectKeys)(state).filter(function(key){return(0,_index.isNestedStateProp)(key)&&rules.required(state[key].value)&&typeof state[key].value==='boolean';});return selected.length>=block.properties.minSelected;}return true;},maxOptions:function maxOptions(){var _block$properties24;if((_block$properties24=block.properties)!=null&&_block$properties24.maxSelected){var selected=(0,_index.objectKeys)(state).filter(function(key){return(0,_index.isNestedStateProp)(key)&&rules.required(state[key].value)&&typeof state[key].value==='boolean';});return selected.length<=block.properties.maxSelected;}return true;},recaptcha:function recaptcha(){if(state.id==='recaptcha'){return rules.required(state.value);}return true;}};if(!state.isVisible){return{valid:true};}var valid=true;var reason=null;for(var key in validators){var validator=validators[key];if(!validator()){valid=false;reason=reasonToErrorMessageKeyMap[key];break;}}return{valid:valid,reason:reason,block:block};}